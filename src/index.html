<!DOCTYPE html>
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge;chrome=1" > 
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <title>ASPIRED</title>


  <!-- Stylesheets -->
    <link rel="stylesheet" href="../node_modules/@fortawesome/fontawesome-free/css/fontawesome.min.css">
    <link rel="stylesheet" href="../node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="./styles.css">
    <link rel="stylesheet" href="./heatmap.css">
    <link rel="stylesheet" href="../node_modules/js9/js9support.css">
    <link rel="stylesheet" href="../node_modules/js9/js9.css">

  <!-- Scripts -->
  <script>
    var pyshell =  require('python-shell').PythonShell;
    var $ = require("../node_modules/jquery/dist/jquery.min.js");
    var jQuery = require("../node_modules/jquery/dist/jquery.min.js");
    const path = require('path');
    const exec = require("child_process").exec;
    const filesystem = require("fs");
  </script>
  <script type="text/javascript" src="../node_modules/jquery/dist/jquery.min.js"></script>
  <script type="text/javascript" src="../node_modules/@fortawesome/fontawesome-free/js/solid.min.js"></script>
  <script type="text/javascript" src="../node_modules/@fortawesome/fontawesome-free/js/fontawesome.min.js"></script>
  <script type="text/javascript" src="../node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
  <script type="text/javascript" src="./myjs9prefs.js"></script>
  <script type="text/javascript" src="../node_modules/js9/js9support.js"></script>
  <script type="text/javascript" src="../node_modules/js9/js9.js"></script>
  <script type="text/javascript" src="../node_modules/js9/js9plugins.js"></script>
  <script type="text/javascript" src="../node_modules/js9/js9usermenus.js"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

</head>

<body>
  <div class="wrapper">
    <nav id="sidebar">
      <div class="sidebar-header">
          <h3>ASPIRED</h3>
      </div>
      <ul class="list-unstyled components">
        <li>
          <a id='home'>Home</a>
        </li>
        <li>
          <a href="#imageSubmenu" data-toggle="collapse" class="dropdown-toggle">Images</a>
            <!-- The <<href="#imageSubmenu">> has to match <<id="imageSubmenu">> -->
          <ul class="collapse list-unstyled show" id="imageSubmenu">
            <li>
              <a id="imageScience">Science</a>
            </li>
            <li>
              <a id="imageStandard">Standard</a>
            </li>
            <li>
              <a id="imageDark">Dark</a>
            </li>
          </ul>
        </li>
        <li>
          <a href="#identifySubmenu" data-toggle="collapse" class="dropdown-toggle">Identify Spectrum</a>
          <ul class="collapse list-unstyled show" id="identifySubmenu">
            <!-- The <<href="#identifySubmenu">> has to match <<id="identifySubmenu">> -->
            <li>
              <a id="identifyScience">Science</a>
            </li>
            <li>
              <a id="identifyStandard">Standard</a>
            </li>
          </ul>
        </li>
        <li>
          <a id="extract">Extract Spectrum</a>
        </li>
        <li>
          <a id="waveCal">Wavelength Calibration</a>
        </li>
      </ul>
    </nav>

    <!-- Page Content Holder -->
    <div id="content">

      <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
          <button type="button" id="sidebarCollapse" class="navbar-btn">
            <span></span>
            <span></span>
            <span></span>
          </button>
          <button class="btn btn-dark d-inline-block d-lg-none ml-auto" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
            <i class="fas fa-align-justify"></i>
          </button>
          <h2>Automated SpectroPhotometric Image REDuction pipeline</h2>
<!--
          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="nav navbar-nav ml-auto">
              <li class="nav-item active">
                <a class="nav-link" href="#">Note 1</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">Note 2</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="#">Note 3</a>
              </li>
            </ul>
          </div>
        -->
        </div>
      </nav>

      <div class="body">
        
        <div class="home">
          <h2>Importing, Tracing and Extracting Spectrum</h2>
          <p>Load a FITS file from system.</p>
        </div>

        <div class="imageScience">
          <div class="row">
            &nbsp; &nbsp; &nbsp;
            <div class="col-xs-4">
              <button type="button" class="btn btn-primary" onclick="javascript:loadFITS()">Load test FITS</button>
            </div>
            &nbsp;
            <div class="col-xs-4">
              <label class="btn btn-primary" for="loadfile">Load FITS file<input id='loadfile' type='file' hidden></label>
            </div>
            &nbsp;
            <div class="col-xs-4">
              <!-- First button group -->
              <div class="btn-group" role="group">
                <button id="btnGroupDrop1" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Scale &nbsp; &nbsp; &nbsp;
                </button>
                <div class="dropdown-menu" aria-labelledby="btnGroupDrop1">
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetScale('zmax')">ZMax</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetScale('zscale')">ZScale</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetScale('dataminmax')">MinMax</a>
                </div>
              </div>
            </div>
            &nbsp;
            <div class="col-xs-4">
              <!-- Second button group -->
              <div class="btn-group" role="group">
                <button id="btnGroupDrop2" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Colourmap &nbsp; &nbsp; &nbsp;
                </button>
                <div class="dropdown-menu" aria-labelledby="btnGroupDrop2">
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('grey')">Grey</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('heat')">Heat</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('cool')">Cool</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('viridis')">Viridis</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('magma')">Magma</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('inferno')">Inferno</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('plasma')">Plasma</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('i8')">i8</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('aips0')">aips0</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('sls')">sls</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('a')">a</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('b')">b</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('bb')">bb</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('he')">he</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('hsv')">hsv</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('rainbow')">Rainbow</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('staircase')">Staircase</a>
                  <a class="dropdown-item" href="#" onclick="javscript:JS9.SetColormap('standard')">Standard</a>
                </div>
              </div>
            </div>
            &nbsp;
            <div class="col-xs-4">
              <div id='scale' class="btn-group btn-group-toggle" data-toggle="buttons">
                <label class="btn btn-secondary active">
                  <input type="radio"> Log
                </label>
                <label class="btn btn-secondary">
                  <input type="radio"> Linear
                </label>
              </div>
            </div>
          </div>

          <!--
          <div id="heatmap"></div>
          <div class="JS9Menubar" data-width="1000px"></div>
          -->
          <p></p>
          <div class="JS9" data-width="1000px" data-height="400px" width='1000px'></div>
<p>Trace</p>
          <div class="row">
            &nbsp; &nbsp; &nbsp;
            <div class="col-xs-3">
              <div id='aptrace' class="btn-group btn-group-toggle" data-toggle="buttons">
                <label class="btn btn-secondary active" id='auto'>
                  <input type="radio"> Auto
                </label>
                <label class="btn btn-secondary" id='manual'>
                  <input type="radio"> Manual
                </label>
              </div>
            </div>

            &nbsp;
            <div class="col-xs-4">
              <!-- First button group -->
              <div class="btn-group" role="group">
                <button id="btnGroupDrop3" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Spectral Direction &nbsp; &nbsp; &nbsp;
                </button>
                <div id='saxis' class="dropdown-menu" aria-labelledby="btnGroupDrop3">
                  <a class="dropdown-item" href="#">Horizontal</a>
                  <a class="dropdown-item" href="#">Vertical</a>
                </div>
              </div>
            </div>

            &nbsp;
            <div class="col-xs-4">
              <!-- First button group -->
              <div class="btn-group" role="group">
                <button id="btnGroupDrop3" type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                  Fit Type &nbsp; &nbsp; &nbsp;
                </button>
                <div id='fittype' class="dropdown-menu" aria-labelledby="btnGroupDrop3">
                  <a class="dropdown-item" href="#">Spline</a>
                  <a class="dropdown-item" href="#">Polynomial</a>
                </div>
              </div>
            </div>

            &nbsp;
            <div class="col-xs-4">
              <div class="input-group mb-3">
                <div class="input-group-prepend">
                  <button class="btn btn-primary" type="button" aria-pressed="false">Order</button>
                </div>
                <input type="value" class="form-control" placeholder="" aria-label="Example text with button addon" aria-describedby="button-addon1" value='3' id='order' style="width: 40px;">
              </div>
            </div>
            <div>
              &nbsp;
              <button type="button" class="btn btn-primary aptrace-auto" onclick="javascript:specTrace('auto')">Identify Brightest Spectrum</button>
              <button type="button" class="btn btn-primary aptrace-manual" style="display: none;" onclick="javascript:addBox()">Mark Spectrum</button>
              <button type="button" class="btn btn-primary aptrace-manual" style="display: none;" onclick="javascript:specTrace('manual')">Identify Spectrum</button>
              <button type="button" class="btn btn-danger" onclick="javascript:JS9.RemoveRegions()">Clear All</button>
            </div>
          </div>

<p>Extract</p>

          <div class="row">
            &nbsp; &nbsp; &nbsp;
            <div class="col-xs-3">
              <div id='extracttype' class="btn-group btn-group-toggle" data-toggle="buttons">
                <label class="btn btn-secondary active" id='optimal'>
                  <input type="radio"> Optimal
                </label>
                <label class="btn btn-secondary" id='tophat'>
                  <input type="radio"> Tophat
                </label>
              </div>
            </div>
            &nbsp;
            <button type="button" class="btn btn-primary" onclick="javascript:specExtract()">Extract Spectrum</button>
          </div>

        <div class="line"></div>
        <h2>Extracted Spectrum</h2>
        <br>
        <div class="extractedSpectrum"></div>

      </div>

    </div>
  </div>

  <script type="text/javascript">
    $(document).ready(function() {

      $('#sidebarCollapse').on('click', function () {
          $('#sidebar').toggleClass('active');
          $(this).toggleClass('active');
      });

    });

    JS9.globalOpts.mouseActions[0] = "display value/position";
    JS9.globalOpts.mouseActions[1] = "pan the image";
    JS9.globalOpts.mouseActions[2] = "change contrast/bias";
    JS9.globalOpts.mouseActions[3] = "zoom";
    JS9.globalOpts.touchActions[0] = "display value/position";
    JS9.globalOpts.touchActions[1] = "pan the image";
    JS9.globalOpts.touchActions[2] = "change contrast/bias";
    JS9.globalOpts.touchActions[3] = "zoom";
    JS9.globalOpts.clearImageMemory = "auto";
    JS9.globalOpts.mousetouchZoom = "true";

    var imgOpts = {
      scale: "log",
      colormap: "grey"
    };

    JS9.textColorOpts = {
      regions: "#C7D401",
      info: "#C7D401",
      inimage: "#000000"
    };

    loadfile.addEventListener('change', readURL);

    function readURL(input) {
      var inputfile = input.target.files[0];
      var filename = inputfile.name;
      opts = {
          ...imgOpts,
          ...{
          parentFile: "fits/" + filename
        }
      }
      JS9.Load(inputfile, opts, {
        display: "JS9"
      });
    }

    function addBox() {
      JS9.RemoveRegions('box');
      var spec_height = JS9.images[0].raw.header.NAXIS2,
          spec_width = JS9.images[0].raw.header.NAXIS1;
      if (saxis == 1) {
        JS9.AddRegions('box', {height: 25, width: spec_width});
      } else {
        JS9.AddRegions('box', {height: spec_height, width: 25});
      }
    }

    function loadFITS() {
      JS9.Load('http://www.astro.ljmu.ac.uk/~ariclam/tempfile/example_sprat_flattened.fits');
    }

    // Toggle display log/linear scale
    $('#scale').click(function() {
      if (JS9.GetScale().scale == 'log') {
        JS9.SetScale('linear');
      } else {
        JS9.SetScale('log');
      }
    });

    // Toggle auto/manual tracing
    $('#aptrace').click(function() {
      if ($('#aptrace #auto').hasClass('active')) {
        $('.aptrace-auto').hide();
        $('.aptrace-manual').show();
      } else {
        $('.aptrace-auto').show();
        $('.aptrace-manual').hide();
      }
    });

    // Toggle optimal/tophat tracing
    var optimal = 'optimal';
    $('#extracttype').on('click', function () {
      if($('#optimal').hasClass('active')) {
        optimal = 'tophat';
      } else {
        optimal = 'optimal';
      }
    });

    // Select spline/polynomial
    var fittype = 'spline';
    $('#fittype a').click(function(){
      fittype = $(this).text().toLowerCase();
    });

    // Select spectral direction, 0 = vertical, 1 = horizontal
    var saxis = 1;
    $('#saxis a').click(function(){
      if ($(this).text() == 'Horizontal') {
        saxis = 1;
      } else {
        saxis = 0;
      }
    });

    var myTrace;

    function specTrace(mode) {
      JS9.RemoveRegions('point');
      var spectrum = JS9.images[0].raw,
          spec_width = spectrum.header.NAXIS1,
          spec_height = spectrum.header.NAXIS2;

      var trace = '';
      var offset = 0;
      console.log(fittype);
      var order = $('#order')[0].value;
      if (mode == 'manual') {

        var box = JS9.GetRegions('box')[0],
          box_height = box.height,
          box_width = box.width;
        
        if (saxis == 1) {
          var box_center = box.y,
              spec_low = box_center - box_height / 2.,
              spec_high = box_center + box_height / 2.
        } else {
          var box_center = box.x,
              spec_low = box_center - box_width / 2.,
              spec_high = box_center + box_width / 2.
        }
        
        offset += spec_low;

        var shell = new pyshell(path.join(__dirname, 'apIdentify.py'), { mode: 'text', args: [spec_low, spec_high, saxis, fittype, order]});
        shell.send(JSON.stringify(spectrum));
      } else {
        if (saxis == 1) {
          var shell = new pyshell(path.join(__dirname, 'apIdentify.py'), { mode: 'text', args: [0, spec_height, saxis, fittype, order]});
        } else {
          var shell = new pyshell(path.join(__dirname, 'apIdentify.py'), { mode: 'text', args: [0, spec_width, saxis, fittype, order]});
        }

        shell.send(JSON.stringify(spectrum));
      }
      
      // append the stdout messages
      shell.on('message', function(message) {
        trace += message;
      });
      
      // convert into JSON object when all messages are received
      shell.end(function(err) {
        if (err) console.log(err);
        myTrace = JSON.parse(trace);
        
        //console.log(trace[0][0]['mu']+1);
        // plot the trace
        if (saxis == 1) {
          for (var i=0; i<myTrace.length; i++) {
              JS9.AddRegions('point', {x:i+1, y:myTrace[i][i]['mu']+1+offset, radius:1});
          }
        } else {
          for (var i=0; i<myTrace.length; i++) {
              JS9.AddRegions('point', {y:i+1, x:myTrace[i][i]['mu']+1+offset, radius:1});
          }
        }
      });
    }

    var science_spec;
    var standard_spec;
    function specExtract() {
      var spectrum = JS9.images[0].raw,
          spec_width = spectrum.header.NAXIS1,
          spec_height = spectrum.header.NAXIS2,
          spec_temp = '';
      console.log(optimal);
      let shell = new pyshell(path.join(__dirname, 'apExtract.py'), { mode: 'text', args: [saxis, optimal]});
      shell.send(JSON.stringify({"spectrum": spectrum, "myTrace": myTrace}));
      
      // append the stdout messages
      shell.on('message', function(message) {
        spec_temp += message;
        //console.log(message);
      });
      
      // convert into JSON object when all messages are received
      shell.end(function(err) {
        if (err) console.log(err);
        //console.log(spec);
        science_spec = JSON.parse(spec_temp);
        
        // plot the trace
        // Load the Visualization API and the corechart package.
        google.charts.load('current', {'packages':['corechart']});

        // Set a callback to run when the Google Visualization API is loaded.
        google.charts.setOnLoadCallback(function(){drawChart(science_spec)});

      });

      // Callback that creates and populates a data table,
      // instantiates the pie chart, passes in the data and
      // draws it.
      function drawChart(spec) {
        
        // Create the data table.
        var data = new google.visualization.DataTable();
        // assumes "word" is a string and "count" is a number
        data.addColumn('number', 'pixel');
        data.addColumn('number', 'Source');
        data.addColumn('number', 'Sky');
        data.addColumn('number', 'Uncertainty');

        for (var i = 0; i < spec.length; i++) {
            data.addRow([
                i,
                spec[i][i]['spec'],
                spec[i][i]['sky'],
                spec[i][i]['err']
            ]);
        }

        // Set chart options
        var options = {'title': 'Extracted Spectrum',
                       'widht': 800,
                       'height': 400,
           'chartArea':{width:'80%',height:'90%'},
           'explorer': {},
           'vAxis': { 'title': 'ADU', 'logScale': true },
           'hAxis': { 'title': 'Pixel (Spectral Direction)'}
        };

        var chart = new google.visualization.LineChart(document.getElementsByClassName('extractedSpectrum')[0]);
        chart.draw(data, options);
      }

      }

  </script>

</body>

</html>
