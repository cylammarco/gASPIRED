(function(k){var m,t,u,n=Object.prototype.hasOwnProperty;k.plot.plugins.push({init:function(p,v){var h=v.Canvas;null==m&&(t=h.prototype.getTextInfo,u=h.prototype.addText,m=h.prototype.render);h.prototype.render=function(){if(!p.getOptions().canvas)return m.call(this);var d=this.context,e=this._textCache;d.save();d.textBaseline="middle";for(var a in e)if(n.call(e,a)){var c=e[a],b;for(b in c)if(n.call(c,b)){var g=c[b],j=!0,l;for(l in g)if(n.call(g,l)){var f=g[l],h=f.positions,k=f.lines;j&&(d.fillStyle=
f.font.color,d.font=f.font.definition,j=!1);for(var f=0,q;q=h[f];f++)if(q.active)for(var r=0,s;s=q.lines[r];r++)d.fillText(k[r].text,s[0],s[1]);else h.splice(f--,1);0==h.length&&delete g[l]}}}d.restore()};h.prototype.getTextInfo=function(d,e,a,c,b){if(!p.getOptions().canvas)return t.call(this,d,e,a,c,b);var g,j;e=""+e;g="object"===typeof a?a.style+" "+a.variant+" "+a.weight+" "+a.size+"px "+a.family:a;c=this._textCache[d];null==c&&(c=this._textCache[d]={});j=c[g];null==j&&(j=c[g]={});b=j[e];if(null==
b){c=this.context;"object"!==typeof a&&(b=k("<div>&nbsp;</div>").css("position","absolute").addClass("string"===typeof a?a:null).appendTo(this.getTextLayer(d)),a={lineHeight:b.height(),style:b.css("font-style"),variant:b.css("font-variant"),weight:b.css("font-weight"),family:b.css("font-family"),color:b.css("color")},a.size=b.css("line-height",1).height(),b.remove());g=a.style+" "+a.variant+" "+a.weight+" "+a.size+"px "+a.family;b=j[e]={width:0,height:0,positions:[],lines:[],font:{definition:g,color:a.color}};
c.save();c.font=g;e=(e+"").replace(/<br ?\/?>|\r\n|\r/g,"\n").split("\n");for(d=0;d<e.length;++d)j=e[d],g=c.measureText(j),b.width=Math.max(g.width,b.width),b.height+=a.lineHeight,b.lines.push({text:j,width:g.width,height:a.lineHeight});c.restore()}return b};h.prototype.addText=function(d,e,a,c,b,g,j,h,f){if(!p.getOptions().canvas)return u.call(this,d,e,a,c,b,g,j,h,f);b=this.getTextInfo(d,c,b,g,j);c=b.positions;d=b.lines;a+=b.height/d.length/2;a="middle"==f?Math.round(a-b.height/2):"bottom"==f?Math.round(a-
b.height):Math.round(a);window.opera&&12>window.opera.version().split(".")[0]&&(a-=2);for(f=0;b=c[f];f++)if(b.x==e&&b.y==a){b.active=!0;return}b={active:!0,lines:[],x:e,y:a};c.push(b);for(f=0;c=d[f];f++)"center"==h?b.lines.push([Math.round(e-c.width/2),a]):"right"==h?b.lines.push([Math.round(e-c.width),a]):b.lines.push([Math.round(e),a]),a+=c.height}},options:{canvas:!0},name:"canvas",version:"1.0"})})(jQuery);
